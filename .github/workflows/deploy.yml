name: Deploy to Server

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      app:
        description: 'App to deploy (e.g., demo-ai-chat)'
        required: true
        default: 'demo-ai-chat'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            echo "ğŸš€ Starting deployment..."

            # Navigate to app directory
            cd /apps/${{ github.event.inputs.app || 'demo-ai-chat' }}

            # Pull latest changes
            echo "ğŸ“¦ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # Pull latest Docker images
            echo "ğŸ³ Pulling Docker images..."
            docker compose pull

            # Rebuild and start services
            echo "ğŸ”¨ Rebuilding and starting services..."
            docker compose up -d --build

            # Cleanup old images
            echo "ğŸ§¹ Cleaning up..."
            docker image prune -f

            # Verify deployment
            echo "âœ… Verifying deployment..."
            sleep 5
            curl -sf http://localhost:8000/health || echo "Health check failed, checking logs..."

            # Show status
            echo "ğŸ“Š Container status:"
            docker compose ps

            echo "âœ… Deployment complete!"
